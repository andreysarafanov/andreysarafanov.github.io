<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title>Map for Poland</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script src="coordinates.js" type="text/javascript"></script>

    <script type="text/javascript">
        let houses = []
        let arrByZone = {}

        function readCsvFile(e) {
            document.getElementById('kml-input').disabled = true
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                houses = parseContent(e.target.result)
            };
            reader.readAsText(file);
            document.getElementById('kml-input').disabled = false
        }

        function readKmlFile(e) {
            var file = e.target.files[0];
            if (!file) {
                return;
            }
            var reader = new FileReader();
            reader.onload = function (e) {
                parseKmlFile (e.target.result)
            };
            reader.readAsText(file);
        }

        function parseKmlFile(content) {
            console.log(`parse start, content.length=${content.length}`)
            parser = new DOMParser();
            xmlDoc = parser.parseFromString(content, "text/xml");
            var placemarks = xmlDoc.getElementsByTagName("Placemark");
            window.placemarks = placemarks
            console.log(`placemarks written to window`)

            let i = 0;
            arrByZone = {}
            for (let pm of placemarks) {
                let name = pm.getElementsByTagName("name")[0].innerHTML
                console.log(`name: ${name}`)
                let coordinates = pm.getElementsByTagName("coordinates")[0].innerHTML.trim()
                let polygon = parsePolygon(coordinates)
                let housesInZone = filterHousesInPolygon(houses, polygon)
                arrByZone[name] = groupStreetsByHouse(housesInZone)
            }

            Object.keys(arrByZone).forEach(z => console.log(`${z}: ${arrByZone[z].length}`))
        }
        
        window.onload = function (){
            console.log('onload window')
            document.getElementById('csv-input').addEventListener('change', readCsvFile, false);
            document.getElementById('kml-input').addEventListener('change', readKmlFile, false);
        }
    </script>
</head>

<body>
    <input id="csv-input" type="file" value="Загрузить базу адресов">Загрузить базу адресов</input>
    <br />
    <input id="kml-input" type="file" value="Открыть kml-файл" disabled>Открыть kml-файл</input>
</body>

</html>